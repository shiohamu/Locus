# リファクタリング計画

作成日: 2025-12-28
最終更新: 2025-12-28

## 1. 概要

このドキュメントは、Locusプロジェクトのリファクタリング計画をまとめたものです。コードの品質向上、保守性の向上、パフォーマンスの最適化を目的としています。

## 2. 現状分析

### 2.1 既に実装済みの改善

以下の改善は既に完了しています：

1. ✅ **ユーティリティ関数の統合**
   - `formatDate`関数は`apps/web/src/lib/utils.ts`に統合され、すべてのコンポーネントで使用されている

2. ✅ **APIクライアントの分割**
   - `apps/web/src/lib/api/`ディレクトリに機能ごとに分割されている
   - `base.ts`, `notes.ts`, `tags.ts`, `rss.ts`, `files.ts`, `search.ts`, `llm.ts`, `sync.ts`, `export.ts`, `graph.ts`, `web-clips.ts`に分割済み

3. ✅ **共通スタイルの抽出**
   - `apps/web/src/lib/styles/`ディレクトリに共通スタイルが抽出されている
   - `buttons.css`, `markdown.css`, `errors.css`, `forms.css`が存在

4. ✅ **コンポーネントの分割**
   - `notes/[id]/+page.svelte`は既に小さなコンポーネントに分割されている
   - `NoteView`, `NoteEdit`, `NoteHeader`, `NoteActions`, `NoteSummary`, `NoteMeta`, `NoteTags`, `NoteLinks`など

5. ✅ **エラーハンドリングの統一**
   - `ErrorDisplay.svelte`コンポーネントが存在
   - `handleApiError`関数が`apps/web/src/lib/utils/error-handling.ts`に実装されている

### 2.2 改善の余地がある点

#### 2.2.1 コード品質の向上

1. **型安全性の向上**
   - `unknown`型の使用は適切だが、より具体的なエラー型を定義できる可能性がある
   - APIレスポンス型の一貫性を確認

2. **テストカバレッジの向上**
   - 既存のテストを確認し、カバレッジを向上させる
   - 新規機能に対するテストの追加

3. **ドキュメントの整備**
   - JSDocコメントの充実
   - コンポーネントの使用方法のドキュメント化

#### 2.2.2 パフォーマンスの最適化

1. **バンドルサイズの最適化**
   - 未使用の依存関係の削除
   - コード分割の最適化

2. **レンダリングパフォーマンス**
   - 不要な再レンダリングの削減
   - メモ化の適切な使用

#### 2.2.3 コードの一貫性

1. **命名規則の統一**
   - 変数名、関数名の命名規則の確認
   - コンポーネント名の統一

2. **コードスタイルの統一**
   - Biomeの設定に従ったコードスタイルの統一
   - インポート順序の統一

## 3. リファクタリング計画

### 3.1 Phase 1: コード品質の向上

**目的**: 型安全性の向上、テストカバレッジの向上、ドキュメントの整備

**タスク**:

1. **型定義の改善**
   - エラー型の定義を明確化
   - APIレスポンス型の一貫性を確認・改善
   - `unknown`型の使用箇所をレビューし、より具体的な型を定義できる場合は改善

2. **テストカバレッジの向上**
   - 既存のテストを実行し、カバレッジを確認
   - 不足しているテストケースを追加
   - E2Eテストの充実

3. **ドキュメントの整備**
   - JSDocコメントの充実（特に公開API）
   - コンポーネントの使用方法のドキュメント化
   - READMEの更新

**影響範囲**:
- すべてのTypeScriptファイル
- テストファイル
- ドキュメントファイル

**推定工数**: 8-10時間

### 3.2 Phase 2: パフォーマンスの最適化

**目的**: バンドルサイズの削減、レンダリングパフォーマンスの向上

**タスク**:

1. **バンドルサイズの最適化**
   - 未使用の依存関係の特定と削除
   - コード分割の最適化
   - 動的インポートの活用

2. **レンダリングパフォーマンスの最適化**
   - 不要な再レンダリングの特定と削減
   - `$:`リアクティブステートメントの最適化
   - メモ化の適切な使用（必要に応じて）

3. **APIリクエストの最適化**
   - 重複リクエストの削減
   - キャッシュ戦略の改善
   - リクエストのバッチ処理

**影響範囲**:
- すべてのコンポーネント
- APIクライアント
- ビルド設定

**推定工数**: 6-8時間

### 3.3 Phase 3: コードの一貫性の向上

**目的**: 命名規則の統一、コードスタイルの統一

**タスク**:

1. **命名規則の統一**
   - 変数名、関数名の命名規則の確認
   - コンポーネント名の統一
   - ファイル名の統一

2. **コードスタイルの統一**
   - Biomeの設定に従ったコードスタイルの統一
   - インポート順序の統一
   - 未使用のインポートの削除

3. **コードの整理**
   - 未使用コードの削除
   - コメントアウトされたコードの削除
   - デバッグコードの削除

**影響範囲**:
- すべてのソースファイル

**推定工数**: 4-6時間

### 3.4 Phase 4: アーキテクチャの改善

**目的**: コードの保守性向上、拡張性の向上

**タスク**:

1. **状態管理の改善**
   - グローバル状態の管理方法の確認
   - Svelteストアの適切な使用
   - 状態の局所化

2. **関心の分離**
   - ビジネスロジックとUIロジックの分離
   - カスタムフックの活用
   - サービス層の明確化

3. **エラーハンドリングの強化**
   - エラー境界の実装
   - エラーログの改善
   - ユーザーフレンドリーなエラーメッセージ

**影響範囲**:
- コンポーネント構造
- 状態管理
- エラーハンドリング

**推定工数**: 8-10時間

## 4. 実装順序

推奨される実装順序：

1. **Phase 3** - コードの一貫性の向上（影響範囲が小さい、リスクが低い）
2. **Phase 1** - コード品質の向上（基盤となる改善）
3. **Phase 2** - パフォーマンスの最適化（Phase 1の後に実施しやすい）
4. **Phase 4** - アーキテクチャの改善（他のPhaseの後に実施）

## 5. テスト戦略

各Phaseの完了後、以下を実施：

1. **ユニットテスト**
   - 変更された関数のテストを実行
   - 既存のテストが通ることを確認

2. **統合テスト**
   - 主要な機能が正常に動作することを確認
   - E2Eテストを実行

3. **パフォーマンステスト**
   - バンドルサイズの測定
   - レンダリングパフォーマンスの測定
   - ロード時間の測定

4. **手動テスト**
   - 主要なユーザーフローをテスト
   - UIの見た目が変わっていないことを確認

## 6. リスク管理

### 6.1 潜在的なリスク

1. **破壊的変更**
   - 型定義の改善により、既存のコードで型エラーが発生する可能性
   - **対策**: 段階的に型を厳密化し、エラーを修正

2. **パフォーマンスの劣化**
   - 最適化により、予期しないパフォーマンスの劣化が発生する可能性
   - **対策**: 各変更後にパフォーマンステストを実施

3. **機能の回帰**
   - リファクタリングにより、既存の機能が動作しなくなる可能性
   - **対策**: 各Phase後に包括的なテストを実施

### 6.2 ロールバック計画

各Phaseは独立して実装できるため、問題が発生した場合は該当Phaseのみをロールバック可能。

## 7. 成功基準

リファクタリングが成功したと判断する基準：

1. **コード品質の向上**
   - 型エラーが0件（または最小限）
   - テストカバレッジが80%以上
   - Biomeのlintエラーが0件

2. **パフォーマンスの維持・向上**
   - バンドルサイズが10%以上削減
   - レンダリング時間が10%以上短縮
   - ロード時間が10%以上短縮

3. **コードの一貫性**
   - 命名規則が統一されている
   - コードスタイルが統一されている
   - 未使用コードが0件

4. **テストの通過**
   - すべての既存テストが通過
   - 新規テストが追加されている

5. **ドキュメントの整備**
   - すべての公開APIにJSDocコメントが追加されている
   - READMEが最新の状態になっている

## 8. 次のステップ

この計画に同意いただけた場合、Phase 3から順次実装を開始します。

各Phaseの実装前に、詳細な実装計画を提示し、承認を得てから実装を進めます。

## 9. 既存のリファクタリング計画との関係

既存のリファクタリング計画（`docs/refactoring_plan.md`の旧版）で指摘されていた問題の多くは既に解決されています：

- ✅ `formatDate`関数の重複 → 既に統合済み
- ✅ `API_BASE_URL`の重複 → 既に`getApiBaseUrl()`関数で統一済み
- ✅ スタイルの重複 → 既に共通スタイルファイルに抽出済み
- ✅ APIクライアントの肥大化 → 既に機能ごとに分割済み
- ✅ コンポーネントの肥大化 → 既に小さなコンポーネントに分割済み
- ✅ エラーハンドリングの統一 → 既に`ErrorDisplay`コンポーネントと`handleApiError`関数で統一済み

本計画は、これらの改善を前提として、さらなる品質向上を目指すものです。
